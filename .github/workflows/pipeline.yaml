name: Deploy Dynatrace Master-Agent

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
  
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary

      - name: Add Known Hosts
        run: |
          ssh-keyscan -H ${{ secrets.PUPPET_SERVER_HOST }} >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ secrets.PUPPET_AGENT_HOST }} >> ~/.ssh/known_hosts

      - name: Update Master and Trigger Agent
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PUPPET_SERVER_HOST }}
          username: ${{ secrets.PUPPET_SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Attempt to install deprecated module (still works for now, but deprecated/archived since 2024)
            sudo puppet module install dynatrace-dynatraceoneagent --ignore-dependencies || echo "Module install failed; consider switching to direct installer script"

            # Ensure the manifests directory exists (critical fix)
            sudo mkdir -p /etc/puppetlabs/code/environments/production/manifests

            # Update (or overwrite) site.pp with the Dynatrace class for your agent node
            # IMPORTANT: Replace '<agent-host>' with the ACTUAL certname/hostname of your agent
            # (run `facter fqdn` or `hostname -f` on the agent to get it; Puppet is case-sensitive)
            sudo bash -c 'cat <<EOF > /etc/puppetlabs/code/environments/production/manifests/site.pp
            node '\''<agent-host>'' {   # <-- CHANGE THIS to your agent's real hostname, e.g., ip-172-31-45-67.ec2.internal or puppetagent.mydomain.com
              class { '\''dynatraceoneagent'\'': 
                tenant_url => \"${{ secrets.DYNATRACE_TENANT_URL }}\",
                paas_token => \"${{ secrets.DYNATRACE_PAAS_TOKEN }}\",
                verify_signature => true,
                oneagent_params_hash => {
                  '\''--set-infra-only'\''      => '\''false'\'',
                  '\''--set-app-log-content-access'\'' => '\''true'\'',
                },
                reboot_system => true,
              }
            }

            # Optional: default node for anything unmatched (good practice)
            node default {
              notify { '\''No specific config for this node'\'' : }
            }
            EOF'

            # Optional: Fix permissions if needed (Puppet server runs as root/pe-puppet)
            sudo chown -R root:root /etc/puppetlabs/code/environments/production/manifests
            sudo chmod 644 /etc/puppetlabs/code/environments/production/manifests/site.pp

      - name: Run Agent Pull
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PUPPET_AGENT_HOST }}
          username: ${{ secrets.PUPPET_AGENT_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: sudo puppet agent -t